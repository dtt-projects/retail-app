/**
 * @module routes/controllers/API_updateItem
 * @fileoverview API_updateItem route's controller. Handle all business logic
 *    relative to API_updateItem for the DB
 * @exports {Object} Functions to attach to the `API_updateItem` router.
 * @require read-hidden
 * @require cookie-helper
 */

/* hidden
 * This is to read the hidden credentials file
 */
 const hidden = require('../../scripts/read-hidden.js');

 /* cookies
  * This is to help with handle cookies for user validation
  */
 const cookies = require('../../scripts/cookie-helper.js');


/**
 * @function updateItem
 * @description update an item in the DB based on data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const updateItem = (req, res, next) => {
  //  read creds from the secret file
  hidden.readHidden()
    .then(json => {
      // get the requires packages
      var mysql = require("mysql");
      var request = require("request");

      // connect to the database
      var con = mysql.createConnection({
        host: json[0]["host"],
        user: json[0]["user"],
        password: json[0]["password"],
        database: json[0]["database"]
      });
      con.connect(function(err) {
        if (err) {
          console.log(err);
        }
      });
      console.log("connected");

      // prepare the data for transmission
      var data = {
        "merchantId" : req.body["merchantId"],
        "name" : req.body["name"],
        "cat": req.body["cat"],
        "desc": req.body["desc"],
        "imageLink": req.body["imageLink"],
        "price": req.body["price"],
        "quantity": req.body["quantity"]
      };

      // build out the request for the api call
      var options = {
        method: 'PUT',
        url: 'https://api.us-south.apiconnect.appdomain.cloud/lasermusibmcom-dev/sb/capstone-1.0/Inventory/' + req.body["itemId"],
        headers: {
          accept: 'application/json',
          'content-type': 'application/json',
          'x-ibm-client-secret': json[2]["ClientSecret"],
          'x-ibm-client-id': json[2]["ClientId"]
        },
        body: data,
        json: true
      };

      // based on request either send back failure and log it
      // or send back success code
      request(options, function (error, response, body) {
        if (error) {
          console.error('Failed updateItem: %s', error.message);
          res.status(400);
          res.send();
        } else {
          res.status(200);
          res.send();
          console.log('Success: ', body);
        }
      });

    });
};

// so other files can call this function
module.exports = {
  updateItem,
};
