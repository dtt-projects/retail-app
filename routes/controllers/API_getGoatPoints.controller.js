/**
 * @module routes/controllers/API_getItem
 * @fileoverview API_getItem route's controller. Handle all business logic
 * relative to API_getItem for the users.
 * @exports {Object} Functions to attach to the `API_getItem` router.
 * @require read-hidden
 * @require cookie-helper
 */

 /* hidden
  * This is to read the hidden credentials file
  */
 var hidden = require('../../scripts/read-hidden.js');

 /* cookies
  * This is to help with handle cookies for user validation
  */
 const cookies = require('../../scripts/cookie-helper.js');


/**
 * @function getGoatPoints
 * @description Log a user in based on the received form data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const getGoatPoints = (req, res, next) => {
  //  read creds from the secret file
  console.log(req.body);
  hidden.readHidden()
    .then(json => {
      // updates and validates the user's cookies
      console.log("DA COOKIES");
      console.log(req.body);
      cookies.handleNormalPageCookie(req.body)
        .then(res_cookie => {
          console.log("GOAT POINTS");
          console.log(res_cookie);
          if (false) {
            res.clearCookie("CID");
            res.status(401);
            res.send();
          } else {
            res.cookie("CID", res_cookie);
            // required packages for db connection and api call
            var mysql = require("mysql");
            var request = require("request");

            // connect to the database
            var con = mysql.createConnection({
              host: json[0]["host"],
              user: json[0]["user"],
              password: json[0]["password"],
              database: json[0]["database"]
            });
            con.connect(function(err) {
              if (err) {
                console.log(err);
                res.setHeader('Content-Type', 'plain/text');
                res.status(400);
                res.send();
              }
            });
            // get username from cookie
            try {
              var username = req.body["username"];
            } catch (e) {
              console.error(e);
              con.end();
              res.status(200);
              res.send();
            }
            var statement = ("SELECT aid from accounts "
                + "where username='" + username + "'");
            con.query(statement, function(err, result) {
              if (err) {
                console.log(err);
                res.status(400);
                res.setHeader('Content-Type', 'plain/text');
                con.end();
                res.send("getting aid failed!");
              } else if (result.length > 0) {
                var aid = result[0]["aid"];
                var statement2 = ("SELECT goatpoints from rewards "
                    + "where aid='" + aid + "'");
                console.log(statement2);
                con.query(statement2, function(err, result2) {
                  if (err) {
                    console.log(err);
                    res.status(400);
                    res.setHeader('Content-Type', 'plain/text');
                    con.end();
                    res.send("getting points failed!");
                  } else if (result2.length > 0) {
                    console.log(result2);
                    res.status(200);
                    res.setHeader('Content-Type', 'text/html');
                    con.end();
                    var data = JSON.parse(result2[0]["goatpoints"].toString());
                    console.log(data);
                    console.log("data ^");
                    res.send(data.toString());
                  } else {
                    console.log("No user exists with goat points history");
                    res.status(400);
                    res.setHeader('Content-Type', 'plain/text');
                    con.end();
                    res.send("Error");
                  }
                });
              } else {
                console.log(err);
                res.status(400);
                res.setHeader('Content-Type', 'plain/text');
                con.end();
                res.send("user doesnt exist failed!");
              }
            });
          }
        });
      });
};

// so other files can call this function
module.exports = {
  getGoatPoints,
};
