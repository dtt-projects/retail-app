/**
 * @module routes/controllers/API_createAccount
 * @fileoverview API_createAccount route's controller. Handle all business
 * logic relative to creating an account.
 * @exports {Object} Functions to attach to the `API_createAccounts` router.
 */

const cookies = require('../../scripts/cookie-helper.js');

/**
 * @function createAccount
 * @description Create an account based on the form data and validate.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const createAccount = (req, res, next) => {
  // Capture user-submitted form from client.

  // read database creds from secret file
  const fs = require("fs");
  fs.readFile('.hiddenCreds', (err, data) => {
      if (err) {
        console.log(err);
        res.setHeader('Content-Type', 'plain/text');
        res.send("Account creation failed!");
      } else {
        // get file data and convert to json
        json = JSON.parse(data.toString());
        var email = req.body["email"];
        var mysql = require("mysql");

        // log into database
        var con = mysql.createConnection({
          host: json[0]["host"],
          user: json[0]["user"],
          password: json[0]["password"],
          database: json[0]["database"]
        });
        con.connect(function(err) {
          if (err) {
            console.log(err);
            res.setHeader('Content-Type', 'plain/text');
            res.send("Account creation failed!");
          }
        });

        // current insert statement for database
        statement = ("INSERT INTO account(FIRSTNAME, LASTNAME, ADDRESS," +
                     " CITY, ZIP, EMAIL, PHONENUMBER, USERNAME, PASSWORD, " +
                     "CREATIONDATE, UPDATEDDATE, ISACTIVE, ISADMIN)" +
                     "VALUES('" + req.body["first_name"] + "' ," +
                            "'" + req.body["last_name"] + "' ," +
                            "'" + req.body["address"] + "' ," +
                            "'" + req.body["city"] + "' ," +
                            "'" + req.body["zip"] + "' ," +
                            "'" + req.body["email"] + "' ," +
                            "'" + req.body["phone_number"] + "' ," +
                            "'" + req.body["username"] + "' ," +
                            "'" + req.body["password"] + "' ," +
                            "CURRENT_TIMESTAMP, " +
                            "CURRENT_TIMESTAMP, " +
                            "True, " +
                            "False)");


        // run statement on the database
        con.query(statement, function(err, result) {
          if (err) {
            res.setHeader('Content-Type', 'plain/text');
            res.send("Account creation failed!");
            console.log(err);
          } else {
            // statement was successful
            var nodemailer = require('nodemailer');

            // setup gmail email system from secret file
            var transporter = nodemailer.createTransport({
              service: 'gmail',
                auth: {
                  user: json[1]["email"],
                  pass: json[1]["password"]
                }
            });

            // email from, to, subject, text
            var mailOptions = {
              from: 'compscigoat@gmail.com',
              to:   req.body["email"],
              subject: 'Welcoe to Sprout Creek Farm',
              text: 'Your account for Sprout Creek Farm has been created'
            };

            // send the email out
            transporter.sendMail(mailOptions, function(error, info){
              if (error) {
                console.log(error);
              }
            });

            data = {
              "username": req.body["username"],
              "password": req.body["password"],
              "isAdmin": 0,
              "email": req.body["email"]
            }

            cookies.handleCreateAccountCookie(data)
              .then(res_cookie => {
                res.cookie("CID", res_cookie);
                // send success back to client
                console.log("COOKIE DONE");
                res.setHeader('Content-Type', 'plain/text');
                res.send("Account created!");
              });
          }
        });
      }
  });
};

// allows use outside of the file
module.exports = {
  createAccount,
};
