/**
 * @module routes/controllers/user
 * @fileoverview User route's controller. Handle all business logic relative to
 *    a particular user or a set of users.
 * @exports {Object} Functions to attach to the `users` router.
 */


/**
 * @function login
 * @description Log a user in based on the received form data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const forgotPassword = (req, res, next) => {
  // Capture user-submitted form from client.
  //console.log(req);
  console.log(req.body);
  const fs = require("fs");
  fs.readFile('.hiddenCreds', (err, data) => {
      if (err) {
        throw err;
      } else {
        json = JSON.parse(data.toString());
        console.log(json);
        var email = req.body["email"];

        console.log("API email: " + email);

        var mysql = require("mysql");

        var con = mysql.createConnection({
          host: json[0]["host"],
          user: json[0]["user"],
          password: json[0]["password"],
          database: json[0]["database"]
        });
        con.connect(function(err) {
          if (err) throw err;
          console.log("Connected!");
        });
        statement = ("select * from account where email = '" + email + "'");
        var response = "";
        con.query(statement, function(err, result) {
          if (err) {
            throw err;
          } else {
            console.log(result);
            response = result;
            if (response.length > 0) {
              var nodemailer = require('nodemailer');

              var transporter = nodemailer.createTransport({
                service: 'gmail',
                  auth: {
                    user: json[1]["email"],
                    pass: json[1]["password"]
                  }
              });
              console.log("EMAIL JSON: " + json[1]["email"]);
              console.log("PASSWORD JSON: " + json[1]["password"]);
              var mailOptions = {
                from: 'compscigoat@gmail.com',
                to:   'aantaki316@gmail.com',
                subject: 'Sending Email using Node.js',
                text: 'GOATS!!!'
              };

              transporter.sendMail(mailOptions, function(error, info){
                if (error) {
                  console.log(error);
                } else {
                  console.log('Email sent: ' + info.response);
                }
              });

              var db_email = response[0]["email"];
              console.log("Sending email to... " + db_email);
              res.setHeader('Content-Type', 'plain/text');
              res.send("email sent!");
            } else {
              console.log("bad email to: " + db_email);
              res.setHeader('Content-Type', 'plain/text');
              res.send("email failed!");
            }
          }
        });
      }
  });
};

module.exports = {
  forgotPassword,
};
