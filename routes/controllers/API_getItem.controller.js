/**
 * @module routes/controllers/API_getItem
 * @fileoverview API_getItem route's controller. Handle all business logic
 * relative to API_getItem for the users.
 * @exports {Object} Functions to attach to the `API_getItem` router.
 * @require read-hidden
 * @require session-helper
 */

 /* hidden
  * This is to read the hidden credentials file
  */
 var hidden = require('../../scripts/read-hidden.js');

 /* sessions
  * This is to help with handling sessions to maintain cart and auth
  */
 const sessions = require('../../scripts/session-helper.js');


/**
 * @function getItem
 * @description Get a single item from IBM DB
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const getItem = (req, res, next) => {
  // get the item num from the url
  var itemNum = req.baseUrl.split("/")[3];
  //  read creds from the secret file
  hidden.readHidden()
    .then(json => {
      // required package for request to DB
      var request = require("request");

      // setup the api call and point it towards a single item
      var options = {
        method: 'GET',
        url: json[2]["apiUrl"] + 'Inventory/' + itemNum,
        headers:
          { accept: 'application/json',
            'x-ibm-client-secret': json[2]["ClientSecret"],
            'x-ibm-client-id': json[2]["ClientId"] }
      };

      // if call fails log error and send back 400
      // if call successful send back the single item's data
      request(options, function (error, response, body) {
        if (error) {
          console.log("Failed getItem: " + error.message);
          res.status(400);
          res.setHeader('Content-Type', 'plain/text');
          res.send();
        } else {
          try {
            data = JSON.parse(body.toString())
          } catch (e) {
            console.log("market item error");
            console.log(body);
            console.log(itemNum);
            console.log("end market item error");
          }
          res.send(data["data"]["inventoryList"]);
        }
      });
    });
};

// so other files can call this function
module.exports = {
  getItem,
};
