/**
 * @module routes/controllers/API_login
 * @fileoverview API_login route's controller. Handle all business logic
 * relative to login for the users.
 * @exports {Object} Functions to attach to the `users` router.
 */

 var hidden = require('../../scripts/read-hidden.js');
 const cookies = require('../../scripts/cookie-helper.js');


/**
 * @function getItem
 * @description Log a user in based on the received form data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const getItem = (req, res, next) => {
  //  read creds from the secret file
  var itemNum = req.baseUrl.split("/")[3];
  console.log(req.baseUrl);
  console.log("itemNum api: ");
  console.log(itemNum);
  hidden.readHidden()
    .then(json => {
      //console.log("JSON");
      //console.log(json);

      var mysql = require("mysql");
      var request = require("request");

      // connect to the database
      var con = mysql.createConnection({
        host: json[0]["host"],
        user: json[0]["user"],
        password: json[0]["password"],
        database: json[0]["database"]
      });
      con.connect(function(err) {
        if (err) {
          res.setHeader('Content-Type', 'plain/text');
          console.log(err);
        }
      });
      //console.log("connected");
      //console.log('https://api.us-south.apiconnect.appdomain.cloud/lasermusibmcom-dev/sb/capstone-1.0/Inventory/' + itemNum);
      var options ={
        method: 'GET',
        url: 'https://api.us-south.apiconnect.appdomain.cloud/lasermusibmcom-dev/sb/capstone-1.0/Inventory/' + itemNum,
        headers:
          { accept: 'application/json',
            'x-ibm-client-secret': json[2]["ClientSecret"],
            'x-ibm-client-id': json[2]["ClientId"] }
      };

      request(options, function (error, response, body) {
        if (error) {
          console.log('error');
          console.log(error.message);
          res.send(error.message);
        } else {
          //console.log(body);
          data = JSON.parse(body.toString())
          res.send(data["data"]["inventoryList"]);
        }
      });
    });
};

// so other files can call this function
module.exports = {
  getItem,
};
