/**
 * @module routes/controllers/API_login
 * @fileoverview API_login route's controller. Handle all business logic
 * relative to login for the users.
 * @exports {Object} Functions to attach to the `users` router.
 */


/**
 * @function login
 * @description Log a user in based on the received form data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const login = (req, res, next) => {
  // Capture user-submitted form from client.
  var username = req.body["username"];
  var password = req.body["password"];

  //  read creds from the secret file
  const fs = require("fs");
  fs.readFile('.hiddenCreds', (err, data) => {
      if (err) {
        throw err;
      } else {
        json = JSON.parse(data.toString());
        var mysql = require("mysql");

        // connect to the database
        var con = mysql.createConnection({
          host: json[0]["host"],
          user: json[0]["user"],
          password: json[0]["password"],
          database: json[0]["database"]
        });
        con.connect(function(err) {
          if (err) {
            throw err;
          }
        });

        // get username and password to comprare to
        statement = ("select username, password, isadmin from account where username = '"
            + username + "'");
        con.query(statement, function(err, result) {
          if (err) {
            res.setHeader('Content-Type', 'plain/text');
            res.send("none");
            throw err;
          } else {
            var db_username = result[0]["username"];
            var db_password = result[0]["password"];
            // if valid creds send to proper dashboard if admin or not
            if (username == db_username && password == db_password) {
              var isAdmin = result[0]["isadmin"];
              if (isAdmin == 1) {
                res.setHeader('Content-Type', 'plain/text');
                res.send("admin");
              } else {
                res.setHeader('Content-Type', 'plain/text');
                res.send("user");
              }
            }  else {
              res.setHeader('Content-Type', 'plain/text');
              res.send("none");
            }
          }
        });
      }
  });
};

// so other files can call this function
module.exports = {
  login,
};
