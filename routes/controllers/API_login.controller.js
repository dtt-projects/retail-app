/**
 * @module routes/controllers/API_login
 * @fileoverview API_login route's controller. Handle all business logic
 * relative to login for the users.
 * @exports {Object} Functions to attach to the `users` router.
 */

 var hidden = require('../../scripts/read-hidden.js');
 const cookies = require('../../scripts/cookie-helper.js');


/**
 * @function login
 * @description Log a user in based on the received form data from the client.
 * @param {Object} req The request object generated by `Express`.
 * @param {Object} res The response object generated by `Express`.
 * @param {Function} next The function to call when this method is done executing
 *    and does not return or render anything (no `res` methods called).
 */
const login = (req, res, next) => {
  // Capture user-submitted form from client.
  var username = req.body["username"];
  var password = req.body["password"];

  //  read creds from the secret file
  hidden.readHidden()
    .then(json => {
      var mysql = require("mysql");

      // connect to the database
      var con = mysql.createConnection({
        host: json[0]["host"],
        user: json[0]["user"],
        password: json[0]["password"],
        database: json[0]["database"]
      });
      con.connect(function(err) {
        if (err) {
          res.setHeader('Content-Type', 'plain/text');
          res.status(401);
          res.send("/login");
          console.log(err);
        }
      });
      console.log("connected");
      // get username and password to comprare to
      statement = ("select username, password, isadmin, email "
          + "from accounts where username = '"
          + username + "'");
      con.query(statement, function(err, result) {
        if (err) {
          res.setHeader('Content-Type', 'plain/text');
          res.status(401);
          console.log("user doesnt exist");
          res.send("/login");
          console.log(err);
        } else if (result.length > 0) {
          var db_username = result[0]["username"];
          var db_password = result[0]["password"];
          // if valid creds send to proper dashboard if admin or not
          console.log(username);
          console.log(password);
          if (username == db_username && password == db_password) {
            console.log("valid");
            var isAdmin = result[0]["isadmin"];
            data = {
              "username": db_username,
              "password": db_password,
              "isAdmin": isAdmin,
              "email": result[0]["email"]
            }
            console.log("data")
            console.log(data);
            if (isAdmin == 1) {
              cookies.handleLoginCookie(null, data)
                .then(cookie => {
                  console.log(cookie);
                  res.cookie("CID", cookie);
                  res.setHeader('Content-Type', 'plain/text');
                  res.status(200);
                  res.send("/admin_dashboard");
                });
            } else {
              cookies.handleLoginCookie(null, data)
                .then(cookie => {
                  res.cookie("CID", cookie);
                  res.setHeader('Content-Type', 'plain/text');
                  res.status(200);
                  res.send("/user_dashboard");
                });
            }
          }  else {
            console.log("q");
            console.log(result);
            res.setHeader('Content-Type', 'plain/text');
            res.status(401);
            res.send("/login");
          }
        } else {
          console.log(result);
          console.log("user doesnt exist");
          res.setHeader('Content-Type', 'plain/text');
          res.status(401);
          res.send("/login");
        }
      });
    });





};

// so other files can call this function
module.exports = {
  login,
};
